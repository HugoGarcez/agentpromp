generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Company {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  users     User[]
  config    AgentConfig?
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  role      String   @default("USER") // ADMIN, USER
  companyId String
  company   Company  @relation(fields: [companyId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Password Reset
  resetToken        String? // Hashed or raw token
  resetTokenExpires DateTime?
}

model AgentConfig {
  id           String   @id @default(uuid())
  companyId    String   @unique
  company      Company  @relation(fields: [companyId], references: [id])
  systemPrompt String?
  persona      String?  // JSON
  integrations String?  // JSON
  products     String?  // JSON
  knowledgeBase String? // JSON - Files text and Scraped URLs
  
  // Promp API Integration
  prompIdentity String?
  prompUuid     String?
  prompToken    String?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  history      PromptHistory[]
  
  // Follow-up Config
  followUpConfig String? // JSON: { enabled, attempts: [], tone: '' }
}

model ContactState {
    id String @id @default(uuid())
    companyId String
    remoteJid String // Phone Number
    
    lastOutbound DateTime? // When did we last message them?
    nextFollowUp DateTime? // When is the next AI msg scheduled?
    attemptIndex Int @default(0) // 0 to 4
    isActive Boolean @default(false) // Is the sequence running?
    metadata String? // JSON: { name: 'Hugo', context: 'Sales' }
    
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([companyId, remoteJid])
}

model PromptHistory {
  id            String      @id @default(uuid())
  agentConfigId String
  agentConfig   AgentConfig @relation(fields: [agentConfigId], references: [id], onDelete: Cascade)
  systemPrompt  String?
  createdAt     DateTime    @default(now())
}



model TestMessage {
  id        String   @id @default(uuid())
  companyId String
  sender    String   // 'user' | 'ai'
  text      String
  sessionId String?  // Optional: For grouping messages by ticket/session (e.g. from Webhook)
  metadata  String?  // Optional: JSON string for extra data (e.g. n8n payload)
  createdAt DateTime @default(now())
}

model GlobalConfig {
  id                String   @id @default(uuid())
  openaiKey         String?
  geminiKey         String?
  elevenLabsKey     String?
  elevenLabsVoiceId String?
  updatedAt         DateTime @updatedAt
}
